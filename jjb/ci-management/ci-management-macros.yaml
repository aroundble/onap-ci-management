---
# vim: sw=2 ts=2 sts=2 et :
- builder:
    name: packer-validate
    builders:
      - config-file-provider:
          files:
            - file-id: 'packer-cloud-env'
              variable: 'CLOUDENV'
      # yamllint disable rule:line-length
      - shell: |
          cd packer
          varfiles="../packer/vars/*"
          templates="../packer/templates/*"
          provision="../packer/provision/*.sh"
          for v in $varfiles; do
              [[ "${{v##*/}}" =~ ^(cloud-env.*)$ ]] && continue
              for t in $templates; do
                  export PACKER_LOG="yes" && \
                  export PACKER_LOG_PATH="packer-validate-${{v##*/}}-${{t##*/}}.log" && \
                              packer.io validate -var-file=$CLOUDENV \
                              -var-file=$v $t
                  if [ $? -ne 0 ]; then
                      break
                  fi
              done
          done
          for p in $provision; do
              /bin/bash -n $p > provision-validate-${{p##*/}}.log 2>&1
          done
      # yamllint enable

- builder:
    name: packer-build
    builders:
      - shell: |
          cd packer
          export PACKER_LOG="yes"
          export PACKER_LOG_PATH="packer-build.log"
          packer.io build -color=false \
            -var-file=$CLOUDENV \
            -var-file=vars/{platform}.json \
            templates/{template}.json
